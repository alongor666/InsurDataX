
# 车险经营分析周报应用

本项目是一个基于 Next.js, React, ShadCN UI, Tailwind CSS 和 Genkit (用于AI功能) 构建的车险经营分析仪表盘应用。

## 目标

旨在为车险业务分析人员和管理层提供一个直观、高效的数据可视化分析平台，帮助他们快速洞察业务表现、识别风险与机遇，并支持数据驱动的决策。

## 主要功能

- **KPI看板**: 实时展示核心业务指标。默认显示最新一周的累计数据。
    - **对比逻辑**: KPI卡片显示与“对比周期”的变化（绝对值和百分比/百分点）。看板下方统一显示当前数据周期与所选对比周期的信息（例如 “当前数据周期：XXXX | 对比 YYYY”或“对比 上一期”）。箭头物理方向始终表示数值增减（上增下减），颜色（红/绿/灰）表示业务含义好坏。
    - 布局为4x4网格。卡片最小高度调整为`min-h-[115px]`以优化视觉，整体看板尺寸有所压缩。对于非率值/占比类指标，卡片右上角显示单位（如“万元”）；其他则显示与指标内在本质相关的图标。
    - 数值显示遵循全局格式化规则，"保费"指标变化颜色根据变动成本率动态调整。
    - 第四列KPI为：保费占比, 满期出险率, 案均赔款, 已报件数。
- **趋势分析**:
    - 根据所选指标类型智能切换图表：率值类指标使用折线图，数值类指标使用柱状图。柱状图有数据标签。
    - 可视化关键指标在时间维度上的变化趋势。业务类型名称以缩写形式显示。
    - **环比数据模式**：图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。对于率值指标，Y轴单位显示为 (pp)，Tooltip中变化值也显示为pp。
    - 线条/柱子颜色根据变动成本率动态变化（基于YTD 动成本率）。数值显示遵循全局格式化规则。Tooltip和AI分析中，“变动成本率”显示名称已更新。
    - 支持AI趋势图分析，功能按钮和内容显示在图表下方。
- **对比气泡图**: 多维度比较不同业务类型的表现。用户可自定义X轴、Y轴和气泡大小的指标。气泡颜色根据变动成本率动态变化，无图例。数值显示遵循全局格式化规则。业务类型名称以缩写形式显示。Tooltip和AI分析中，“变动成本率”显示名称已更新。AI分析功能按钮和内容显示在图表下方。
- **水平条形图排名**: 对业务类型（以缩写显示）按选定指标（包含KPI看板核心指标）进行排名。条形颜色根据变动成本率动态变化。数据标签、轴刻度遵循全局格式化规则。图表高度已优化，Y轴显示业务类型缩写名称，X轴有动态单位标签。Tooltip和AI分析中，“变动成本率”显示名称已更新。AI分析功能按钮和内容显示在图表下方。
- **占比图**: 使用饼图展示各业务类型（以缩写显示）在所选绝对值指标上的贡献占比。扇区颜色根据变动成本率动态变化。饼图扇区不直接显示数据标签。**图例按占比降序、三列（每列最多5项）方式显示业务类型缩写和占比百分比**。Tooltip和AI分析中，“变动成本率”显示名称已更新。支持AI分析，功能按钮和内容显示在图表下方。图表高度调整为 `h-[450px]`。
- **帕累托图**: 使用组合图（柱状图+折线图）分析关键少数贡献（80/20法则）。用户可选择绝对值指标。柱子颜色根据变动成本率动态变化。业务类型名称以缩写形式显示，**X轴业务类型标签横向显示**。Tooltip和AI分析中，“变动成本率”显示名称已更新。支持AI分析，功能按钮和内容显示在图表下方。
- **数据表**: 展示详细的原始及聚合数据。数值显示遵循全局格式化规则。业务类型名称以缩写形式显示。当选择自定义对比周期时，对比数据显示为与该周期的差异，对比列名会动态更新。
- **全局筛选与控制**:
    - 支持分析模式切换（累计/当周发生额）。
    * 支持当前数据周期选择。
    * 支持自定义对比周期选择：用户可以选择任一周作为对比基准，影响KPI看板和数据表的对比数据。
    * **业务类型筛选 (已增强)**: 下拉菜单顶部提供“全选”、“反选”、“清除”操作；中间列出所有业务类型，每项前有复选框，旁边有“仅选此项”按钮；底部有“确认”和“取消”按钮。“全选”、“反选”和复选框勾选需要点击“确认”生效，“清除”和“仅选此项”立即生效。
    * 支持数据源切换：可在JSON文件和PostgreSQL数据库（待完全实现）之间切换。
- **AI智能分析**:
    * 生成结构化的总体业务摘要（位于页面顶部），根据筛选条件（包括自定义对比周期）动态调整。输出使用Markdown渲染，并解释变动成本率所代表的业务状态（例如“经营优秀/低风险”、“警告/高风险”），而不是直接描述颜色。**AI分析内容全中文，视觉层禁止英文，字体大小与图表AI分析一致**。
    * 为各个图表（趋势图、气泡图、排名图、占比图、帕累托图）生成独立的、结构化的AI解读。AI分析的功能按钮和内容显示区域统一位于对应图表的下方。 AI分析会考虑变动成本率的业务状态，并使用Markdown渲染。**AI分析内容全中文，不描述颜色，而是用业务状态（如“经营优秀/低风险”）分析**。
- **动态颜色提示**: 图表根据变动成本率动态调整颜色（红、蓝、绿，深浅变化），突出风险和机会。变动成本率<88%为绿色（值越小越深），88%-92%为蓝色（值越接近88%越深），>=92%为红色（值越大越深）。
- **数据导出**: 支持将数据表内容导出为CSV，数值为原始精度，表头含单位。文件名和列名会反映自定义对比周期。
- **全局数值格式化**: 应用内数值显示（KPI、图表、数据表）遵循统一规则（如小数位、百分号、千位分隔符），单位通过上下文或KPI卡片右上角提供。

## 技术栈

- **前端**:
    - Next.js (App Router)
    - React
    - TypeScript
    - ShadCN UI (组件库)
    - Tailwind CSS (样式)
    - Recharts (图表库)
    - Lucide React (图标)
    - react-markdown (Markdown渲染)
- **AI 功能**:
    - Genkit (Google AI)
- **数据**:
    - 本地 JSON 文件 (`public/data/insurance_data_v4.json`) 作为默认数据源。
    - PostgreSQL (计划支持，连接和查询逻辑待完善)。
- **数据库驱动**:
    - `pg` (node-postgres)

## 项目结构

- `src/app/`: Next.js 页面和布局。
- `src/components/`: 应用的React组件。
    - `layout/`: 页面布局组件。
    - `sections/`: 主要功能区块组件 (KPI看板、图表等)。
    - `shared/`: 可复用的通用组件。
    * `ui/`: ShadCN UI 基础组件。
- `src/ai/`: Genkit相关的AI Flow和配置。
    - `flows/`: 具体的AI分析流程。
- `src/lib/`: 工具函数和核心逻辑。
    - `data-utils.ts`: 数据处理、聚合、KPI计算、全局数值格式化和业务类型名称缩写逻辑的核心。
    - `db.ts`: PostgreSQL数据库连接和查询逻辑（待完善）。
- `src/data/`: 数据类型定义。
- `public/data/`: 存放应用的原始数据文件 (`insurance_data_v4.json`)。
- `PRODUCT_REQUIREMENTS_DOCUMENT.md`: 产品需求文档。
- `FIELD_DICTIONARY_V4.md`: 字段字典与计算逻辑。
- `FIELD_LINEAGE.md`: 数据血缘图 (Mermaid)。
- `ISSUES_LOG.md`: 问题与解决日志。

## 运行项目

1.  确保已安装 Node.js 和 npm/yarn。
2.  安装依赖:
    ```bash
    npm install
    # 或
    yarn install
    ```
3.  （可选）如果计划使用PostgreSQL数据库，请在项目根目录创建 `.env` 文件，并配置以下环境变量：
    ```env
    PGUSER=your_db_user
    PGHOST=your_db_host
    PGDATABASE=your_db_name
    PGPASSWORD=your_db_password
    PGPORT=5432
    # PGSSLMODE=require # 如果数据库需要SSL
    ```
4.  启动开发服务器:
    ```bash
    npm run dev
    # 或
    yarn dev
    ```
    应用通常会在 `http://localhost:9002` (根据`package.json`配置) 启动。

5.  (可选) 如果需要运行或测试Genkit Flows:
    ```bash
    npm run genkit:dev
    # 或查看 package.json 中其他 genkit 相关脚本
    ```
    确保 `.env` 文件中配置了必要的API密钥（如Google AI Studio的API Key）。

## 文档

- **产品需求文档**: `PRODUCT_REQUIREMENTS_DOCUMENT.md` (V2.9)
- **字段字典与计算逻辑**: `FIELD_DICTIONARY_V4.md`
- **数据血缘图**: `FIELD_LINEAGE.md`
- **问题与解决日志**: `ISSUES_LOG.md`

```