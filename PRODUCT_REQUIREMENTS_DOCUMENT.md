
# 产品需求文档 (PRD) - 车险经营分析周报

**版本**: 3.1.0 (AI功能通过Firebase Function后端代理)
**最后更新日期**: 2024-05-30
**负责人**: AI项目大师

## 1. 引言

### 1.1. 目的
本文档旨在明确“车险经营分析周报”应用（以下简称“本应用”）的产品需求。本版本前端仍为静态导出，但AI分析功能通过后端的Firebase Function代理实现。

### 1.2. 范围
本应用的核心目标是为车险业务分析人员和管理层提供一个直观、高效的数据可视化分析平台，帮助他们快速洞察业务表现、识别风险与机遇。数据源固定为本地JSON文件。**AI分析功能通过后端Firebase Function调用Genkit实现。**

### 1.3. 目标受众
*   车险业务分析师
*   车险部门经理/管理层

### 1.4. 术语定义
*   **YTD (Year To Date)**: 本年迄今累计。
*   **PoP (Period over Period)**: 环比。
    *   **KPI看板/数据表中的“环比数据”模式下的对比变化值逻辑**：
        *   当前值 = “当前期PoP值” (即 `当前期YTD - 当前期的上一期YTD`)。
        *   对比基准值 = “对比期PoP值” (即 `对比期YTD - 对比期的上一期YTD`)。
        *   卡片上显示的变化是基于这两个PoP值之间的差异计算的。
        *   对比标签会根据用户选择的对比周期或默认的上一周期动态显示为“对比 [周期名称]”（例如 “对比 2025年第22周” 或 “对比 上一期”）。
    *   **趋势图中的环比数据 (analysisMode='periodOverPeriod')**：对于所有指标（包括率值和绝对值），图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。
*   **自定义对比期**: 用户可从周期列表中选择任一周期作为当前周期的对比基准。
*   **KPI (Key Performance Indicator)**: 关键绩效指标。
*   **业务类型**: 指不同的车险产品线或分类。图表和数据表中显示的业务类型名称会使用预定义的缩写。
*   **数据周期**: 数据统计的时间单位，本应用中指“周”。
*   **累计值分析**: 基于YTD数据的分析。
*   **当周发生额分析 (analysisMode='periodOverPeriod')**:
    *   **KPI看板/数据表**：主数据显示的是“当前期PoP值”。对比数据显示的是与“对比期PoP值”的差异。
    *   **趋势图**：图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。
*   **变动成本率 (Variable Cost Ratio)**: 指满期赔付率与费用率之和。
*   **pp (percentage points)**: 百分点。
*   **数据源 (Data Source)**: 固定为本地JSON文件 (`public/data/insurance_data.json`)。
*   详细的指标定义和计算逻辑请参考项目根目录下的 `FIELD_DICTIONARY_V4.md` 文件。

## 2. 产品概述

### 2.1. 产品愿景
打造一款高效、易用、具备智能分析能力的车险经营分析工具。

### 2.2. 产品目标
*   提升分析效率：通过自动化的数据处理和可视化展示。
*   增强数据洞察：提供多维度、交互式的分析功能，并辅以AI智能解读。
*   统一数据口径：确保核心指标的计算逻辑和数据来源统一。

### 2.3. 核心价值
*   准确性：基于周度数据，提供准确的业务指标。
*   可视化与直观性：通过丰富的图表和卡片，使复杂数据易于理解。
*   灵活性与可配置性：支持分析模式切换、业务类型筛选、数据周期选择、自定义对比周期选择。
*   **安全的AI集成**: 通过Firebase Function代理AI请求，保护API密钥。

## 3. 用户画像与场景

### 3.1. 用户画像
*   李明 (业务分析师)
*   王总 (部门经理)

### 3.2. 核心使用场景
*   场景一：日常业务监控与周报生成
    *   李明打开应用，默认看到最新一周的累计数据KPI看板。
    *   他选择周期、业务类型（支持全选、反选、清除、仅选此项、勾选，部分操作需确认）。
    *   他切换视图（趋势、气泡、排名、占比、帕累托、数据表）进行分析。
    *   他点击AI摘要按钮，前端调用Firebase Function，Function调用Genkit flow生成分析，结果显示在UI上。
    *   他使用“导出”功能导出数据。
*   场景二：管理层快速概览
    *   王总打开应用，浏览KPI看板和图表，并查看AI生成的业务摘要。
*   场景三：专项问题分析 (特定周期对比)
    *   同上，利用AI分析辅助识别问题。

## 4. 核心功能需求

### 4.1. KPI 看板 (F-KPI)
*   (同V3.0.0，但AI相关功能现在可用，通过Firebase Function调用)

### 4.2. 趋势分析 (F-TREND)
*   (同V3.0.0，但AI图表分析功能现在可用)

### 4.3. 对比气泡图 (F-BUBBLE)
*   (同V3.0.0，但AI图表分析功能现在可用)

### 4.4. 水平条形图排名 (F-RANK)
*   (同V3.0.0，但AI图表分析功能现在可用)

### 4.5. 占比图 (F-SHARE)
*   (同V3.0.0，但AI图表分析功能现在可用)

### 4.6. 帕累托图 (F-PARETO)
*   (同V3.0.0，但AI图表分析功能现在可用)

### 4.7. 数据表显示 (F-TABLE)
*   (同V3.0.0)

### 4.8. 全局筛选与控制
*   F-CTRL-001: 分析模式切换
*   F-CTRL-002: 当前数据周期选择
*   F-CTRL-002B: 对比数据周期选择
*   F-CTRL-003: 业务类型筛选 (同V3.0.0最终实现)
*   F-CTRL-004: 数据导出
*   F-CTRL-005: 视图切换

### 4.9. AI 智能分析 (通过Firebase Function)
*   F-AI-001: 总体业务摘要。通过调用后端的AI代理Firebase Function实现。
*   F-AI-002: 图表AI分析。各图表独立的AI分析，同样通过调用后端Firebase Function实现。
*   F-AI-003: **API密钥安全**: API密钥配置在Firebase Function的环境变量中，不由前端直接管理。

## 5. 非功能性需求
*   (同V3.0.0，但强调前端静态，后端动态处理AI请求)
*   NF-SEC-001: **AI API密钥安全**: API密钥存储在Firebase Function环境变量中，不暴露于客户端。
*   NF-PERF-001: AI请求为异步，UI应有加载状态提示，避免阻塞。

## 6. 设计与用户体验
*   (同V3.0.0)
*   6.4 AI交互: AI摘要按钮触发异步请求，UI显示加载状态，结果以Markdown格式渲染。

### 6.3. 全局数值显示格式化规则
*   (同V3.0.0)

## 7. 数据需求
*   主要数据源: **固定为** `public/data/insurance_data.json`。
*   AI分析输入数据: 由前端根据当前筛选和图表状态准备，传递给Firebase Function。

## 8. 未来展望 (可选)
*   (无变化)

## 9. 附录
*   `FIELD_DICTIONARY_V4.md`
*   `FIELD_LINEAGE.md` (若存在)
*   `ISSUES_LOG.md`

---
修订历史

| 版本  | 日期       | 修订人     | 修订说明                                                                 |
| :---- | :--------- | :------- | :----------------------------------------------------------------------- |
| ...   | ...        | ...      | ...                                                                      |
| 3.0.0 | 2024-05-29 | AI项目大师 | 转为完全静态版本：移除数据库支持，禁用动态AI分析功能。应用固定使用JSON数据源。更新相关文档。 |
| 3.1.0 | 2024-05-30 | AI项目大师 | **重新引入AI功能**: 通过Firebase Function代理AI请求，确保API密钥安全。前端调用此代理，文档相应更新。 |
