
# 产品需求文档 (PRD) - 车险经营分析周报

**版本**: 3.7.0 (AI功能已禁用, 静态JSON数据源)
**最后更新日期**: (当前日期)
**负责人**: AI项目大师

## 1. 引言

### 1.1. 目的
本文档旨在明确“车险经营分析周报”应用（以下简称“本应用”）的产品需求。本应用当前版本使用 Firebase Authentication 进行用户认证，数据来源于静态JSON文件，**所有AI智能分析功能已全局禁用**。

### 1.2. 范围
本应用的核心目标是为车险业务分析人员和管理层提供一个直观、高效、安全的数据可视化分析平台。数据源为静态JSON文件 (`public/data/insurance_data.json`)。**AI分析功能已全局禁用。**

### 1.3. 目标受众
*   车险业务分析师
*   车险部门经理/管理层

### 1.4. 术语定义
*   YTD (Year To Date): 本年迄今累计。
*   PoP (Period over Period): 环比。
    *   KPI看板/数据表中的“环比数据”模式下的对比变化值逻辑：
        *   当前值 = “当前期PoP值” (即 `当前期YTD - 当前期的上一期YTD`)。
        *   对比基准值 = “对比期PoP值” (即 `对比期YTD - 对比期的上一期YTD`)。
        *   卡片上显示的变化是基于这两个PoP值之间的差异计算的。
        *   对比标签会根据用户选择的对比周期或默认的上一周期动态显示为“对比 [周期名称]”（例如 “对比 2025年第22周” 或 “对比 上一期”）。
    *   趋势图中的环比数据 (analysisMode='periodOverPeriod')：对于所有指标（包括率值和绝对值），图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。
*   自定义对比期: 用户可从周期列表中选择任一周期作为当前周期的对比基准。
*   KPI (Key Performance Indicator): 关键绩效指标。
*   业务类型: 指不同的车险产品线或分类。图表和数据表中显示的业务类型名称会使用预定义的缩写。
*   数据周期: 数据统计的时间单位，本应用中指“周”。周数据显示为上周日至本周六的数据，例如2025年第24周的数据范围是2025年6月8日（周日）至2025年6月14日（周六）。趋势图X轴标签将显示当周最后一天（周六）的日期，格式为 "YY-MM-DD"。
*   累计值分析: 基于YTD数据的分析。
*   当周发生额分析 (analysisMode='periodOverPeriod'):
    *   KPI看板/数据表：主数据显示的是“当前期PoP值”。对比数据显示的是与“对比期PoP值”的差异。
    *   趋势图：图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。
*   变动成本率 (Variable Cost Ratio): 指满期赔付率与费用率之和。
*   pp (percentage points): 百分点。
*   **数据源 (Data Source)**: 通过静态JSON文件 `public/data/insurance_data.json` 提供。此文件可通过公开URL访问。
*   **Firebase Authentication**: 用于用户登录和访问控制。
*   **AI功能**: 所有AI智能摘要和图表分析功能当前已全局禁用。相关后端代码（Firebase Function, Genkit flows）保留，但前端不再调用。
*   详细的指标定义和计算逻辑请参考项目根目录下的 `FIELD_DICTIONARY_V4.md` 文件。

## 2. 产品概述

### 2.1. 产品愿景
打造一款安全、高效、易用的车险经营数据分析工具。

### 2.2. 产品目标
*   提升分析效率：通过自动化的数据处理和可视化展示。
*   增强数据洞察：提供多维度、交互式的分析功能。
*   统一数据口径：确保核心指标的计算逻辑和数据来源统一。
*   **安全访问控制**: 通过 Firebase Authentication 实现用户登录。
*   **AI功能状态**: 所有AI智能摘要和分析功能当前版本已全局禁用。

### 2.3. 核心价值
*   准确性：基于周度数据，提供准确的业务指标。
*   可视化与直观性：通过丰富的图表和卡片，使复杂数据易于理解。趋势图X轴标签将显示当周最后一天（周六）的日期，格式为 "YY-MM-DD"，并且在“累计”模式下标签将水平显示，布局已优化防止溢出。
*   灵活性与可配置性：支持分析模式切换、业务类型筛选、数据周期选择、自定义对比周期选择。
*   **数据文件访问性**: 原始数据 `insurance_data.json` 位于 `public/data` 目录，可通过直接URL访问。
*   **AI功能说明**: 应用界面将提示AI功能已禁用。

## 3. 用户画像与场景

### 3.1. 用户画像
*   李明 (业务分析师)
*   王总 (部门经理)

### 3.2. 核心使用场景
*   场景一：登录并进行日常业务监控与周报生成
    *   李明打开应用，被重定向到登录页。使用其 Firebase Authentication 凭证（例如，邮箱/密码）登录。
    *   登录成功后，应用从静态JSON文件加载保险数据。
    *   默认看到最新一周的累计数据KPI看板。**KPI看板下方的总体业务摘要功能已禁用。**
    *   他选择周期、业务类型。
    *   他切换视图（趋势、气泡、排名、占比、帕累托、数据表）。趋势图X轴标签会显示当周最后一天（周六）的日期 (YY-MM-DD)，方便理解，且布局优化确保标签完整显示。 **各图表下方的独立AI分析功能已禁用。**
    *   他使用“导出”功能导出数据。
    *   分析完毕后，点击“登出”按钮。
*   场景二：管理层快速概览
    *   王总使用其凭证登录应用。应用加载数据。首先浏览KPI看板。然后可能切换到其他图表视图。**所有AI分析功能已禁用。**
*   场景三：专项问题分析 (特定周期对比)
    *   同上，登录后，应用加载数据。利用KPI看板和各图表进行数据分析。

## 4. 核心功能需求

### 4.0. 用户认证 (F-AUTH) - Firebase Authentication
*   **F-AUTH-001: 登录页面**: 应用提供一个 `/login` 路径的登录页面。
*   **F-AUTH-002: 凭证输入**: 登录页面包含邮箱和密码输入框，用于用户输入其 Firebase Authentication 凭证。
*   **F-AUTH-003: Firebase认证**: 用户提交的凭证通过 Firebase Authentication 服务进行校验。
*   **F-AUTH-004: 会话管理**: Firebase Authentication 自动管理用户会话和ID令牌的刷新与持久化。
*   **F-AUTH-005: 路由保护**: 未登录用户访问仪表盘页面 (`/`) 时，应被自动重定向到登录页面 (`/login`)。
*   **F-AUTH-006: 登出功能**: 应用头部提供“登出”按钮。点击后，调用 Firebase Authentication 的登出方法，清除当前用户会话，并将用户重定向到登录页面。
*   **F-AUTH-007: 登录状态持久化**: Firebase Authentication 自动处理用户登录状态的持久化（例如，在浏览器刷新后保持登录状态），直到用户主动登出或会话过期。

### 4.1. 数据提供 (F-DATA) - 静态JSON
*   **F-DATA-001: 公开数据文件**: 原始的 `insurance_data.json` 文件位于 `public/data` 目录，可通过直接URL公开访问。
*   **F-DATA-002: 前端获取**: 前端应用直接通过 `fetch('/data/insurance_data.json')` 获取全部保险数据。

### 4.2. KPI 看板 (F-KPI)
*   **F-KPI-001: 核心指标展示**: 实时展示车险业务的核心关键绩效指标（KPIs），如边际贡献率、变动成本率、费用率、满期赔付率、保费、费用、赔款、满期保费、保费满期率、单均保费、保单件数、保费占比、满期出险率、案均赔款、已报件数。
*   **F-KPI-002: 默认视图**: 默认显示最新可获取数据周期的累计数据。
*   **F-KPI-003: 对比数据显示**: 每个KPI卡片显示与所选“对比周期”（或默认的上一期）的数值变化，包括百分比变化和绝对值变化（或百分点变化）。
*   **F-KPI-004: 周期信息展示**: 看板下方清晰显示当前数据周期和所选对比周期的标签。
*   **F-KPI-005: 布局与样式**: KPI卡片采用网格布局（例如4x4），卡片具有统一的最小高度和视觉样式。数值显示遵循全局格式化规则。
*   **F-KPI-006: 风险高亮**: 特定KPI（如变动成本率、满期赔付率）根据其数值是否达到风险阈值进行视觉高亮（例如，颜色变化或边框提示）。
*   **F-KPI-007: AI摘要禁用提示**: KPI看板下方的原AI智能总体业务摘要功能已禁用，相关UI区域会明确提示用户AI功能已暂停。

### 4.3. 趋势分析 (F-TREND)
*   **F-TREND-001: 图表类型智能切换**: 根据所选指标的性质（率值类或绝对数值类），自动切换使用折线图或柱状图进行趋势展示。
*   **F-TREND-002: 环比数据模式**: 在“当周发生额分析”模式下，图表上每个数据点的值代表 `当前周期对应指标的YTD值 - 上一周期对应指标的YTD值`。
*   **F-TREND-003: X轴标签优化**: X轴的周期标签将显示当周的最后一天（周六）的日期，格式为 "YY-MM-DD"（例如 "25-06-14"）。在“累计”分析模式下，X轴标签将始终水平显示。Tooltip中的周期显示会包含完整的周起止日期范围。
*   **F-TREND-004: 布局优化**: 通过调整图表边距，确保图表内容（包括坐标轴、图例、标签）在标准视图下不会溢出其容器。
*   **F-TREND-005: 动态颜色提示**: 图表中的线条或柱子颜色根据对应数据点的变动成本率（YTD）动态变化，以视觉化方式提示业务健康度。
*   **F-TREND-006: AI分析禁用提示**: 图表下方的原独立AI图表分析功能已禁用，相关UI区域会明确提示用户AI功能已暂停。

### 4.4. 对比气泡图 (F-BUBBLE)
*   **F-BUBBLE-001: 多维度比较**: 提供气泡图，允许用户选择X轴、Y轴和气泡大小对应的三个不同指标，用于多维度比较各业务类型的表现。
*   **F-BUBBLE-002: 动态颜色提示**: 每个业务类型对应的气泡颜色根据其变动成本率（YTD）动态变化，直观反映其经营健康状况。
*   **F-BUBBLE-003: AI分析禁用提示**: 图表下方的原独立AI图表分析功能已禁用，相关UI区域会明确提示用户AI功能已暂停。

### 4.5. 水平条形图排名 (F-RANK)
*   **F-RANK-001: 指标排名**: 提供水平条形图，允许用户选择一个指标，对各业务类型在该指标上的表现进行降序排名。
*   **F-RANK-002: 动态颜色提示**: 每个业务类型对应的条形颜色根据其变动成本率（YTD）动态变化，辅助判断高排名业务的质量。
*   **F-RANK-003: AI分析禁用提示**: 图表下方的原独立AI图表分析功能已禁用，相关UI区域会明确提示用户AI功能已暂停。

### 4.6. 占比图 (F-SHARE)
*   **F-SHARE-001: 贡献占比分析**: 提供饼图（或圆环图），允许用户选择一个绝对值类指标，展示各业务类型在该指标上的贡献占比。
*   **F-SHARE-002: 动态颜色提示**: 每个业务类型对应的扇区颜色根据其变动成本率（YTD）动态变化，评估各构成部分的贡献质量。
*   **F-SHARE-003: AI分析禁用提示**: 图表下方的原独立AI图表分析功能已禁用，相关UI区域会明确提示用户AI功能已暂停。

### 4.7. 帕累托图 (F-PARETO)
*   **F-PARETO-001: 关键少数分析 (80/20法则)**: 提供帕累托图（柱状折线组合图），允许用户选择一个绝对值类指标，分析贡献最大的少数业务类型（通常占80%贡献的关键少数）。
*   **F-PARETO-002: 动态颜色提示**: 图表中代表各业务类型的柱子颜色根据其变动成本率（YTD）动态变化，帮助评估核心贡献业务的健康度。
*   **F-PARETO-003: AI分析禁用提示**: 图表下方的原独立AI图表分析功能已禁用，相关UI区域会明确提示用户AI功能已暂停。

### 4.8. 数据表显示 (F-TABLE)
*   **F-TABLE-001: 详细数据显示**: 提供数据表格视图，展示经过当前筛选条件（分析模式、周期、业务类型）处理后的详细数据。
*   **F-TABLE-002: 数据内容**: 表格应包括各业务线（或合计）的关键指标值（如跟单保费、总赔款、保单数量、满期赔付率、费用率等）。
*   **F-TABLE-003: 对比数据展示**: 在“当周发生额分析”模式下，表格应同时显示当前周期发生额与对比周期发生额的变化情况（绝对值和百分比/百分点变化）。

### 4.9. 全局筛选与控制
*   **F-CTRL-001: 分析模式切换**: 用户可以通过切换开关选择“累计值分析”或“当周发生额分析”模式。
*   **F-CTRL-002: 当前数据周期选择**: 用户可以通过下拉列表选择要分析的当前数据周期。
*   **F-CTRL-002B: 对比数据周期选择**: 用户可以通过下拉列表选择一个历史周期作为当前周期的对比基准。支持清除对比周期选择，恢复为默认的智能环比（通常是上一期）。
*   **F-CTRL-003: 业务类型筛选**: 用户可以通过带复选框的下拉多选菜单筛选一个或多个业务类型。支持全选、反选、清除已选、仅选此项等快捷操作。筛选结果影响所有图表和数据表的显示。
*   **F-CTRL-004: 数据导出**: 提供“导出”按钮，允许用户将当前数据表视图中的数据导出为CSV文件。
*   **F-CTRL-005: 视图切换**: 应用头部提供一组导航按钮，允许用户在不同的分析视图（KPI看板、趋势图、气泡图、排名图、占比图、帕累托图、数据表）之间切换。

### 4.10. AI 智能分析 (已禁用)
*   **F-AI-001: 全局禁用**: 所有AI相关的摘要和图表分析功能均已在前端移除或禁用。应用头部不再包含触发全局AI摘要的按钮。
*   **F-AI-002: UI提示**: 应用界面会在原AI功能区域（如KPI看板下方，各图表下方）明确提示用户AI功能已禁用或暂停。
*   **F-AI-003: 后端保留**: 后端Firebase Function (`generateAiSummaryProxy`) 和Genkit flow代码保留在项目中，但前端不再调用它们，因此相关的AI服务API密钥当前不在前端或Function运行时直接使用。

## 5. 非功能性需求

*   **NF-PERF-001: 数据加载性能**: 前端获取和处理静态JSON数据应为异步操作，UI界面在数据加载过程中应有明确的加载状态提示（例如，骨架屏或加载指示器），避免界面阻塞。
*   **NF-PERF-002: 浏览器流畅性**: 应用应在主流桌面浏览器（Chrome, Firefox, Edge, Safari的最新稳定版本）上流畅运行，图表交互和数据更新不应有明显卡顿。
*   **NF-UI-001: 图表布局与可读性**: 所有图表应在其指定的容器内正确、完整地显示，避免图表内容（如坐标轴标签、图例、数据标签）溢出或被截断。趋势图X轴标签在累计模式下应水平显示，格式为YY-MM-DD，以增强可读性。
*   **NF-UI-002: 界面简洁性**: 应用界面设计应简洁直观，信息层级清晰，方便用户快速理解和操作。
*   **NF-UI-003: 操作反馈**: 用户的操作（如筛选、切换视图）应有及时的视觉反馈。
*   **NF-COMP-001: 浏览器兼容性**: 应用应兼容主流桌面浏览器。
*   **NF-COMP-002: 响应式设计**: 应用应具备基本的响应式设计，能够在常见的桌面显示器分辨率下良好展示。
*   **NF-SEC-001: 数据文件公开性**: 原始数据文件 `insurance_data.json` 位于 `public/data` 目录，这意味着它可以通过直接URL公开访问，不受应用登录机制的保护。此点需明确。
*   **NF-SEC-002: 用户认证安全**: 用户认证通过 Firebase Authentication 实现，用户凭证（如密码）由Firebase安全处理，不在前端代码中存储或直接比较。

## 6. 设计与用户体验

### 6.0. 总体设计原则
*   界面设计应现代化、专业，符合商业分析工具的调性。
*   色彩方案应清晰，有助于数据区分和可读性。应用整体主题色调（如背景、主色、强调色）通过 `globals.css` 文件中的CSS变量统一管理。
*   交互应直观，减少用户学习成本，重要的功能和筛选器应易于发现和使用。

### 6.1. 登录流程
*   用户首次访问应用时，若未通过Firebase Authentication认证，则自动被重定向到登录页面 (`/login`)。
*   登录页面提供清晰的邮箱和密码输入框。
*   用户提交凭证后，通过Firebase Authentication服务进行验证。
*   登录成功后，用户被重定向到主仪表盘页面 (`/`)。
*   若登录失败（例如，凭证错误、用户不存在），登录页面应显示由Firebase提供的或前端定义的明确错误提示信息。

### 6.2. 仪表盘布局与导航
*   应用采用单页仪表盘（SPA-like）设计，主内容区域根据用户选择显示不同的分析视图。
*   应用头部固定显示，包含：
    *   应用标题/Logo。
    *   全局筛选控件：当前数据周期选择器、对比数据周期选择器、业务类型筛选器、分析模式切换开关。
    *   操作按钮：数据导出按钮。
    *   用户状态显示及登出按钮。
*   头部下方为视图切换导航区，提供一组按钮，允许用户在KPI看板、趋势图、气泡图、排名图、占比图、帕累托图和数据表等不同分析视图之间快速切换。

### 6.3. 全局数值显示格式化规则
*   **金额类指标** (如跟单保费, 满期保费, 总赔款, 费用额, 边贡额，单位：万元): 默认显示为整数，使用千位分隔符 (例如 "1,234 万元")。
*   **件数类指标** (如保单数量, 已报件数, 满期保单件数，单位：件): 显示为整数，使用千位分隔符。
*   **百分比类指标** (如满期赔付率, 费用率, 变动成本率, 边际贡献率, 保费满期率, 满期出险率, 保费占比): 默认保留一位小数 (例如 "12.3%")。
*   **特定均值类指标**:
    *   单均保费 (单位：元): 显示为整数，使用千位分隔符。
    *   案均赔款 (单位：元): 显示为整数，使用千位分隔符。
*   **特殊数值指标**:
    *   商业险平均自主系数: 保留三位小数。
*   **空值或无效值**: 当指标无法计算或数据缺失时，应显示为 "-" 或 "N/A" 或 0（根据指标特性和上下文）。
*   **对比变化值**:
    *   百分比变化: 显示为带正负号的百分数，保留一位小数 (例如 "+5.2%", "-10.0%")。
    *   绝对值变化: 根据原指标单位进行格式化，带正负号。
    *   百分点变化 (pp): 用于比率类指标的绝对差值比较，显示为带正负号的数值后加"pp"，保留一位小数 (例如 "+1.5 pp")。

### 6.4. AI交互
*   **AI功能已禁用**: 应用头部不再有触发全局AI摘要的按钮。各图表下方不再有独立的AI分析模块和触发按钮。
*   **UI提示**: 在原先设计有AI摘要或分析功能的区域（例如KPI看板下方、各图表区域下方），应用界面会明确提示用户AI功能已禁用或暂停。

### 6.5. 图表可读性
*   趋势图的X轴标签将清晰显示当周最后一天（周六）的日期，格式为 "YY-MM-DD"，并在“累计”分析模式下水平展示，以提高可读性并避免标签重叠。
*   所有图表的Tooltip提示信息应清晰、准确，包含必要的数据点信息和单位。
*   图表颜色应有明确含义（例如，基于变动成本率的动态颜色提示）或易于区分。

### 6.6. 用户状态
*   应用头部清晰显示当前已登录用户的身份（例如，通过显示用户邮箱）以及一个“登出”按钮。

## 7. 数据需求
*   主要数据源: **静态JSON文件 `public/data/insurance_data.json`**。此文件包含了按周期组织的业务数据，每个周期内包含各业务线的详细指标。数据结构需符合 `V4PeriodData` 类型定义。
*   **Firebase前端配置**: 需要在前端配置Firebase SDK (API Key, Auth Domain等)，通过 `.env.local` 文件管理这些环境变量，以便Firebase Authentication正常工作。

## 8. 未来展望 (可选)
*   数据源迁移：未来可考虑将数据源从静态JSON迁移到数据库（如PostgreSQL），并通过受保护的后端API提供数据，以增强安全性和可扩展性。
*   AI功能重新启用：若业务需求恢复，可重新评估并启用AI分析功能。届时需要确保AI代理Function的稳定运行、认证保护，并可能需要调整数据传递方式。
*   用户管理界面：为管理员提供简单的用户管理功能（如在Firebase控制台操作）。
*   更细致的权限控制：如果未来有不同角色的用户，可能需要引入更细致的权限管理机制。

## 9. 附录
*   `FIELD_DICTIONARY_V4.md` (详细的指标定义与计算逻辑)
*   `FIELD_LINEAGE.md` (若存在，描述字段来源与转换)
*   `ISSUES_LOG.md` (项目问题与解决日志)

---
修订历史

| 版本  | 日期       | 修订人     | 修订说明                                                                                                                               |
| :---- | :--------- | :------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| ...   | ...        | ...      | ... (保留之前所有记录)                                                                                                                   |
| 3.5.0 | (先前日期) | AI项目大师 | 新增原型级用户名/密码登录功能。仪表盘内容受登录保护。                                                                                         |
| 3.6.0 | (先前日期) | AI项目大师 | 集成Firebase Authentication替换原型登录。尝试创建受保护的Firebase Function (`getInsuranceData`) 提供数据及保护AI代理Function，但遇到404问题。 |
| 3.7.0 | (当前日期) | AI项目大师 | **全局禁用了所有AI智能分析功能**，移除了前端相关UI和逻辑。数据源明确为静态JSON (`public/data`)。文档更新以反映AI功能禁用状态和当前架构。     |

