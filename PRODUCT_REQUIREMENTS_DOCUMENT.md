# 产品需求文档 (PRD) - 车险经营分析周报

**版本**: 4.1.0 (安全数据源: 客户端直连Firestore)
**最后更新日期**: (当前日期)
**负责人**: AI项目大师

## 1. 引言

### 1.1. 目的
本文档旨在明确“车险经营分析周报”应用（以下简称“本应用”）的产品需求。本应用当前版本使用 Firebase Authentication 进行用户认证，并通过 **Firebase 客户端SDK 直接从 Firestore 数据库安全地获取数据**。所有AI智能分析功能当前已全局禁用。

### 1.2. 范围
本应用的核心目标是为车险业务分析人员和管理层提供一个直观、高效、**安全**的数据可视化分析平台。数据源为 Firestore 数据库，通过已登录用户的客户端直接访问，并受 Firestore 安全规则保护。**AI分析功能已全局禁用。**

### 1.3. 目标受众
*   车险业务分析师
*   车险部门经理/管理层

### 1.4. 术语定义
*   YTD (Year To Date): 本年迄今累计。
*   PoP (Period over Period): 环比。
*   **数据源 (Data Source)**: **Firestore 数据库**。前端应用在用户通过 Firebase Authentication 认证后，使用 Firebase 客户端SDK直接查询名为 `v4_period_data` 的集合来获取数据。数据访问受 Firestore 安全规则保护，该规则要求用户必须已通过身份验证。
*   **Firebase Authentication**: 用于用户登录和访问控制。
*   **AI功能**: 所有AI智能摘要和图表分析功能当前已全局禁用。

(其他术语定义保持不变)
*   ...

## 2. 产品概述

### 2.1. 产品愿景
打造一款**安全、可靠**、高效、易用的车险经营数据分析工具。

### 2.2. 产品目标
*   提升分析效率：通过自动化的数据处理和可视化展示。
*   增强数据洞察：提供多维度、交互式的分析功能。
*   统一数据口径：确保核心指标的计算逻辑和数据来源统一。
*   **安全访问控制**: 通过 Firebase Authentication 实现用户登录，并确保只有已认证的用户才能从 Firestore 获取业务数据。

### 2.3. 核心价值
*   **安全性**: 用户认证通过 Firebase 实现。业务数据存储于 Firestore，其安全规则确保只有登录用户才能访问，数据不会被公开暴露。
*   准确性：基于周度数据，提供准确的业务指标。
*   可视化与直观性：通过丰富的图表和卡片，使复杂数据易于理解。
*   灵活性与可配置性：支持分析模式切换、业务类型筛选、数据周期选择等。

## 3. 用户画像与场景

### 3.1. 用户画像
*   李明 (业务分析师)
*   王总 (部门经理)

### 3.2. 核心使用场景
*   场景一：登录并进行日常业务监控与周报生成
    *   李明打开应用，被重定向到登录页。使用其 Firebase Authentication 凭证（例如，邮箱/密码）登录。
    *   登录成功后，应用**使用 Firebase 客户端SDK 直接从 Firestore 安全地加载保险数据**。
    *   默认看到最新一周的累计数据KPI看板。**KPI看板下方的总体业务摘要功能已禁用。**
    *   他选择周期、业务类型。
    *   他切换视图（趋势、气泡、排名、占比、帕累托、数据表）。
    *   他使用“导出”功能导出数据。
    *   分析完毕后，点击“登出”按钮。
*   ... (其他场景类似，核心是数据加载方式的改变)

## 4. 核心功能需求

### 4.0. 用户认证 (F-AUTH) - Firebase Authentication
*   **F-AUTH-001: 登录页面**: 应用提供一个 `/login` 路径的登录页面。
*   **F-AUTH-002: 凭证输入**: 登录页面包含邮箱和密码输入框，用于用户输入其 Firebase Authentication 凭证。
*   **F-AUTH-003: Firebase认证**: 用户提交的凭证通过 Firebase Authentication 服务进行校验。
*   **F-AUTH-004: 会话管理**: Firebase Authentication 自动管理用户会话和ID令牌的刷新与持久化。
*   **F-AUTH-005: 路由保护**: 未登录用户访问仪表盘页面 (`/`) 时，应被自动重定向到登录页面 (`/login`)。
*   **F-AUTH-006: 登出功能**: 应用头部提供“登出”按钮。
*   **F-AUTH-007: 登录状态持久化**: Firebase Authentication 自动处理用户登录状态的持久化。

### 4.1. 数据提供 (F-DATA) - 客户端直连Firestore
*   **F-DATA-001: Firestore数据存储**: 原始的保险数据以文档形式存储在后端的 Firestore 数据库的 `v4_period_data` 集合中。
*   **F-DATA-002: Firestore安全规则**: Firestore 的安全规则已配置为 `allow read, write: if request.auth != null;`，确保只有通过 Firebase Authentication 认证的用户才能读写数据。
*   **F-DATA-003: 前端直接获取**: 前端应用在用户登录后，通过 Firebase 客户端SDK直接查询 Firestore 的 `v4_period_data` 集合来获取全部保险数据。

### 4.2. - 4.9. (KPI看板、图表、筛选等)
(这些功能模块的需求描述保持不变，因为它们是基于获取到的数据进行展示和操作，其核心逻辑不受数据源变更的影响。但前提是数据结构保持一致。)

### 4.10. AI 智能分析 (已禁用)
*   **F-AI-001: 全局禁用**: 所有AI相关的摘要和图表分析功能均已在前端移除或禁用。
*   **F-AI-002: UI提示**: 应用界面会在原AI功能区域提示用户AI功能已禁用。
*   **F-AI-003: 后端保留**: 后端Firebase Function (`generateAiSummaryProxy`) 和Genkit flow代码保留，但前端不再调用。

## 5. 非功能性需求

*   **NF-PERF-001: 数据加载性能**: 前端直接从 Firestore 查询数据为异步操作，UI界面在数据加载过程中应有明确的加载状态提示。
*   **NF-SEC-001: 数据访问安全**: 业务数据存储于 Firestore，只能通过已认证的客户端SDK根据 Firestore 安全规则进行访问。严禁任何对业务数据的未认证访问。
*   **NF-SEC-002: 用户认证安全**: 用户认证通过 Firebase Authentication 实现。

(其他非功能性需求如浏览器兼容性、UI简洁性等保持不变。)

## 6. 设计与用户体验
(设计和用户体验部分描述保持不变，因为UI/UX的核心流程未变，仅数据加载的底层实现变化。)

## 7. 数据需求
*   **主要数据源**: **Firestore 数据库**。数据应按周期存储在 `v4_period_data` 集合中，每个周期文档包含该周期的业务数据，结构需符合 `V4PeriodData` 类型定义。
*   **Firebase前端配置**: 需要在前端配置Firebase SDK (API Key, Auth Domain等)，通过 `.env.local` 文件管理。
*   **Firebase后端配置**: 无需部署自定义数据获取云函数。AI代理函数 (`generateAiSummaryProxy`) 保持部署（如果需要）。

## 8. 未来展望 (可选)
(保持不变)

## 9. 附录
(保持不变)

---
修订历史

| 版本  | 日期       | 修订人     | 修订说明                                                                                                                               |
| :---- | :--------- | :------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| ...   | ...        | ...      | ... (保留之前所有记录)                                                                                                                   |
| 4.0.0 | (先前日期) | AI项目大师 | **重大架构变更**：将数据源从静态JSON文件切换为通过安全的Firebase Function从Firestore获取，确保数据安全。更新所有相关文档以反映此新架构。 |
| 4.1.0 | (当前日期) | AI项目大师 | **架构再次调整**：由于Blaze计费计划的限制，移除了对Firebase Function的依赖。数据获取改为由前端客户端在认证后直接安全地访问Firestore，其访问由Firestore安全规则保护。 |
