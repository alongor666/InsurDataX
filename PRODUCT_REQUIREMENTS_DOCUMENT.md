# 产品需求与系统设计文档 (PRD) - 车险经营分析周报

**版本**: 6.0.0 (As-Built: AI功能通过Next.js API路由重新启用)
**最后更新日期**: (当前日期)
**负责人**: AI项目大师

## 1. 引言

### 1.1. 文档目的
本文档作为“车险经营分析周报”应用的**核心设计与实现蓝图 (As-Built Documentation)**。它旨在为开发人员、架构师、测试人员和系统维护者提供一个关于应用功能、技术架构、实现细节和部署方法的全面、精确、单一信息源。

本文档的目标是确保任何具备相应技术栈能力的开发者，都能够**基于此文档从零开始，完整地理解、构建并复刻出与当前线上版本功能完全一致的应用**。

### 1.2. 应用范围与核心价值
本应用是一个**安全、交互式、动态**的车险经营分析仪表盘。其核心价值在于：
*   **安全性**: 通过 **Firebase Authentication** 进行用户认证，并通过 **Firestore 安全规则** 保障后端数据的访问安全。
*   **数据驱动**: 为车险业务分析师和管理层提供一个直观、高效的数据可视化分析平台。
*   **AI赋能**: 内置基于Genkit的AI分析引擎，为各可视化图表提供深度洞察和文字摘要。
*   **标准化**: 确保所有核心业务指标的计算口径和展现逻辑全公司统一。

### 1.3. 目标受众
*   **开发人员**: 用于理解功能需求、技术实现和进行二次开发。
*   **系统维护者**: 用于了解系统架构、部署和排查问题。
*   **产品与业务分析师**: 用于明确已实现的功能和业务逻辑。

### 1.4. 关键术语与定义
| 术语 | 英文/ID | 定义 |
| :--- | :--- | :--- |
| **YTD** | Year To Date | 本年迄今累计值。 |
| **PoP** | Period over Period | 环比分析模式，分析“当周发生额”。 |
| **当周发生额** | Period Value | `当前周期YTD值 - 上一周期YTD值`。在PoP模式下，所有指标均基于此重新计算。 |
| **数据源** | Data Source | **Firestore 数据库**。前端在用户认证后，使用客户端SDK直接查询。 |
| **AI服务网关** | AI Gateway | **Next.js API路由 (`/api/ai`)**。前端通过此路由调用后端的Genkit AI分析流。 |
| **认证服务** | Authentication | **Firebase Authentication**，使用邮箱/密码登录。 |
| **安全模型** | Security Model | **客户端直连 + Firestore安全规则**。 |
| **变动成本率** | `variable_cost_ratio` | `费用率 + 满期赔付率`。是评估业务健康度的核心风险指标。 |
| **边际贡献率** | `marginal_contribution_ratio` | `100% - 变动成本率`。是评估业务盈利能力的核心指标。 |
| **pp** | percentage points | **百分点**。用于描述两个百分比指标之间的差异。 |
| **字段字典** | `FIELD_DICTIONARY.md` | **(重要)** 定义了所有业务指标的精确计算逻辑、数据来源和处理规则。**本文档中所有指标的计算均以此文件为准。** |

---

## 2. 系统架构

### 2.1. 技术栈
*   **前端**:
    *   **框架**: Next.js (App Router, **动态服务器渲染模式**)
    *   **语言**: TypeScript
    *   **UI组件**: ShadCN UI
    *   **样式**: Tailwind CSS
    *   **图表**: Recharts
    *   **状态管理**: React Hooks (`useState`, `useEffect`, `useMemo`, `useCallback`)
    *   **Firebase SDK**: `firebase/app`, `firebase/auth`, `firebase/firestore`
*   **后端/BaaS (Backend as a Service)**:
    *   **数据库**: Google Firestore
    *   **认证**: Firebase Authentication
    *   **AI服务**: **Next.js API路由** (`/api/ai`)，内部调用Genkit。
    *   **AI框架**: Genkit (Google AI)

### 2.2. 数据流架构
本应用采用安全的无服务器 (Serverless) 架构，数据流如下：
1.  **用户访问与认证**: 用户通过 `/login` 页面使用 Firebase Authentication 进行认证。
2.  **主数据获取 (实时)**:
    *   认证成功后，主仪表盘页面 (`/`) 使用 Firestore 客户端SDK的 `onSnapshot` 方法，建立与 `v4_period_data` 集合的**实时监听连接**。
    *   任何在 Firestore 中的数据变更都会被实时推送到客户端，并自动更新UI，无需手动刷新。
    *   数据访问由 Firestore 安全规则保护，仅允许已认证用户读取。
3.  **AI分析请求**:
    *   用户在某个图表（如趋势图、气泡图）上点击“生成AI分析”按钮。
    *   前端组件收集当前图表所需的数据和上下文（如筛选条件、分析模式等），构造一个JSON负载。
    *   前端使用 `fetch` API，向应用自身的 **Next.js API路由 (`/api/ai`)** 发送一个 `POST` 请求。
    *   该API路由在服务器端运行，接收请求后，根据请求中的 `flowName` 调用相应的 **Genkit AI分析流**。
    *   Genkit流执行，与大语言模型进行交互，并生成分析结果。
    *   API路由将AI生成的分析文本以JSON格式返回给前端。
    *   前端接收到响应，更新状态，并将AI分析摘要展示在界面上。

---

## 3. 核心功能需求 (F-REQ)

### 3.1. 用户认证 (F-AUTH)
*(无变更)*

### 3.2. 数据架构与获取 (F-DATA)
*(无变更)*

### 3.3. 全局筛选与控制 (F-CTRL)
*(无变更)*

### 3.4. KPI看板 (F-KPI)
*(无变更)*

### 3.5. 图表与数据视图 (F-VIEWS)
所有图表视图均支持动态数据更新，并集成了独立的AI智能分析功能。

*   **通用AI分析功能 (F-AI-CHART)**
    *   **触发**: 每个图表下方都有一个独立的“生成AI分析”按钮。
    *   **状态**: 点击后，按钮变为“分析中...”状态，并显示加载动画。
    *   **展示**: 分析结果会以Markdown格式，清晰地展示在图表下方的指定区域内。
    *   **错误处理**: 如果AI分析失败，会通过Toast弹窗向用户提示错误信息。
    *   **上下文感知**: AI分析的输入数据会包含当前图表的所有相关上下文，包括：图表数据本身、所选的指标、分析模式、当前周期以及所有全局筛选条件。

*   **趋势分析 (F-TREND)**
    *   **组件**: `src/components/sections/trend-analysis-section.tsx`
    *   **智能图表切换**: 根据所选指标类型，自动在 **折线图 (率值)** 和 **柱状图 (绝对值)** 之间切换。
    *   **动态着色**: 折线图的点和柱状图的柱子颜色根据其对应周期的**变动成本率 (VCR)** 动态变化。
    *   **坐标轴优化**: X轴以**两行格式**显示，第一行为周序号（如 `W24`），第二行为起止日期（如 `0608-0614`），并自动处理标签密度以防重叠。Y轴根据指标单位动态显示标签 (如 `(万元)`, `(pp)`)。
    *   **自定义工具提示 (Tooltip)**: 显示完整的周期范围、指标值和VCR值。

*   **(其他图表视图无重大变更)**

---

## 4. 非功能性需求 (NF-REQ)
*(无变更)*

---

## 5. 项目从0到1复刻指南
*(后端云函数部分被移除，更新为API路由)*

### 5.2. Firebase项目设置
*(该部分无重大变更，但不再需要为云函数启用Blaze套餐)*

### 5.3. 本地应用配置与运行
*(无变更)*

### 5.4. 部署应用 (自动化CI/CD)
*(无变更)*

---

## 6. 修订历史

| 版本  | 日期       | 修订人     | 修订说明                                                                                                                               |
| :---- | :--------- | :------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| ...   | ...        | ...      | ... (保留之前所有记录)                                                                                                                   |
| 5.3.0 | (先前日期) | AI项目大师 | **构建稳定性修复**: 解决了因 `null` 值类型不匹配导致的生产构建 (`npm run build`) 失败问题。通过在 `page.tsx` 中对图表数据进行加固，确保了类型安全。 |
| 6.0.0 | (当前日期) | AI项目大师 | **重大架构重构**: 为规避Firebase Blaze套餐限制，彻底移除云函数依赖。创建了Next.js API路由`/api/ai`作为新的AI服务网关，并重新启用了所有图表的AI智能分析功能及UI。 |
