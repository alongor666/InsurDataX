
# 产品需求文档 (PRD) - 车险经营分析周报

**版本**: 3.6.0 (Firebase Authentication & 受保护的数据/AI)
**最后更新日期**: (当前日期)
**负责人**: AI项目大师

## 1. 引言

### 1.1. 目的
本文档旨在明确“车险经营分析周报”应用（以下简称“本应用”）的产品需求。本应用将集成 Firebase Authentication 进行用户认证，并通过 Firebase Function 提供受保护的数据访问和AI分析功能。

### 1.2. 范围
本应用的核心目标是为车险业务分析人员和管理层提供一个直观、高效、安全的数据可视化分析平台。数据源将从静态JSON文件迁移到通过受保护的Firebase Function提供。AI分析功能通过后端Firebase Function调用Genkit实现，并同样受到认证保护。

### 1.3. 目标受众
*   车险业务分析师
*   车险部门经理/管理层

### 1.4. 术语定义
*   YTD (Year To Date): 本年迄今累计。
*   PoP (Period over Period): 环比。
    *   KPI看板/数据表中的“环比数据”模式下的对比变化值逻辑：
        *   当前值 = “当前期PoP值” (即 `当前期YTD - 当前期的上一期YTD`)。
        *   对比基准值 = “对比期PoP值” (即 `对比期YTD - 对比期的上一期YTD`)。
        *   卡片上显示的变化是基于这两个PoP值之间的差异计算的。
        *   对比标签会根据用户选择的对比周期或默认的上一周期动态显示为“对比 [周期名称]”（例如 “对比 2025年第22周” 或 “对比 上一期”）。
    *   趋势图中的环比数据 (analysisMode='periodOverPeriod')：对于所有指标（包括率值和绝对值），图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。
*   自定义对比期: 用户可从周期列表中选择任一周期作为当前周期的对比基准。
*   KPI (Key Performance Indicator): 关键绩效指标。
*   业务类型: 指不同的车险产品线或分类。图表和数据表中显示的业务类型名称会使用预定义的缩写。
*   数据周期: 数据统计的时间单位，本应用中指“周”。周数据显示为上周日至本周六的数据，例如2025年第24周的数据范围是2025年6月8日（周日）至2025年6月14日（周六）。趋势图X轴标签将显示当周最后一天（周六）的日期，格式为 "YY-MM-DD"。
*   累计值分析: 基于YTD数据的分析。
*   当周发生额分析 (analysisMode='periodOverPeriod'):
    *   KPI看板/数据表：主数据显示的是“当前期PoP值”。对比数据显示的是与“对比期PoP值”的差异。
    *   趋势图：图表上每个点的值代表 `当前期对应指标的YTD值 - 上一期对应指标的YTD值`。
*   变动成本率 (Variable Cost Ratio): 指满期赔付率与费用率之和。
*   pp (percentage points): 百分点。
*   **数据源 (Data Source)**: 通过受 Firebase Authentication 保护的 Firebase Function 提供，源数据位于 Function 的部署包内。
*   **Firebase Authentication**: 用于用户登录和访问控制。
*   详细的指标定义和计算逻辑请参考项目根目录下的 `FIELD_DICTIONARY_V4.md` 文件。

## 2. 产品概述

### 2.1. 产品愿景
打造一款安全、高效、易用、具备深度智能分析能力的车险经营工具。

### 2.2. 产品目标
*   提升分析效率：通过自动化的数据处理和可视化展示。
*   增强数据洞察：提供多维度、交互式的分析功能，并辅以针对各视图的AI智能解读。
*   统一数据口径：确保核心指标的计算逻辑和数据来源统一。
*   **安全访问控制**: 通过 Firebase Authentication 实现用户登录和对数据及AI功能的访问控制。

### 2.3. 核心价值
*   准确性：基于周度数据，提供准确的业务指标。
*   可视化与直观性：通过丰富的图表和卡片，使复杂数据易于理解。趋势图X轴标签将显示当周最后一天（周六）的日期，格式为 "YY-MM-DD"，并且在“累计”模式下标签将水平显示，布局已优化防止溢出。
*   灵活性与可配置性：支持分析模式切换、业务类型筛选、数据周期选择、自定义对比周期选择。
*   安全的AI集成: 通过受保护的 Firebase Function 代理AI请求，保护API密钥。
*   全面的AI分析: KPI看板和每个图表均提供独立的AI摘要功能，提供更细致的业务洞察，且此功能受认证保护。
*   **强化的数据安全**: 原始数据不再通过公共URL暴露，而是通过认证的Firebase Function提供。

## 3. 用户画像与场景

### 3.1. 用户画像
*   李明 (业务分析师)
*   王总 (部门经理)

### 3.2. 核心使用场景
*   场景一：登录并进行日常业务监控与周报生成
    *   李明打开应用，被重定向到登录页。使用其 Firebase Authentication 凭证（例如，邮箱/密码）登录。
    *   登录成功后，应用从受保护的 Firebase Function 加载保险数据。
    *   默认看到最新一周的累计数据KPI看板。
    *   他可以点击应用头部的AI摘要按钮，触发调用受保护的 Firebase Function 生成KPI看板下方的总体业务摘要。
    *   他选择周期、业务类型。
    *   他切换视图（趋势、气泡、排名、占比、帕累托、数据表）。趋势图X轴标签会显示当周最后一天（周六）的日期 (YY-MM-DD)，方便理解，且布局优化确保标签完整显示。 在每个图表视图的下方，都有一个独立的AI分析模块，他可以点击相应的按钮，前端调用受保护的Firebase Function，Function调用Genkit flow生成针对当前图表数据的分析，结果显示在该图表下方的AI摘要区域。
    *   他使用“导出”功能导出数据。
    *   分析完毕后，点击“登出”按钮。
*   场景二：管理层快速概览
    *   王总使用其凭证登录应用。应用安全加载数据。首先浏览KPI看板及其下方的AI生成的总体业务摘要。然后可能切换到其他图表视图，并按需触发该图表的AI分析以获取更具体的解读。所有数据和AI功能均受认证保护。
*   场景三：专项问题分析 (特定周期对比)
    *   同上，登录后，应用安全加载数据。利用KPI看板及其总体分析，以及各图表及其独立的AI分析辅助识别问题。

## 4. 核心功能需求

### 4.0. 用户认证 (F-AUTH) - Firebase Authentication
*   **F-AUTH-001: 登录页面**: 应用提供一个 `/login` 路径的登录页面。
*   **F-AUTH-002: 凭证输入**: 登录页面包含邮箱和密码输入框 (或其他 Firebase Auth 支持的登录方式)。
*   **F-AUTH-003: Firebase认证**: 用户凭证通过 Firebase Authentication 服务进行校验。
*   **F-AUTH-004: 会话管理**: Firebase Authentication 自动管理用户会话和ID令牌。
*   **F-AUTH-005: 路由保护**: 未登录用户访问仪表盘页面 (`/`) 时，应被重定向到登录页面。
*   **F-AUTH-006: 登出功能**: 应用头部提供“登出”按钮，调用 Firebase Authentication 的登出方法，清除会话，并将用户重定向到登录页面。
*   **F-AUTH-007: 登录状态持久化**: Firebase Authentication 自动处理登录状态的持久化。

### 4.1. 数据提供 (F-DATA) - Firebase Function
*   **F-DATA-001: 安全数据接口**: 创建一个Firebase Function (例如 `getInsuranceData`)。
*   **F-DATA-002: 数据源内部化**: 原始的 `insurance_data.json` 文件将从 `public` 目录移至 `functions` 目录内，不再公开可访问。
*   **F-DATA-003: 认证保护**: `getInsuranceData` Function 必须验证调用者的 Firebase ID Token，只有已认证的用户才能获取数据。
*   **F-DATA-004: 前端获取**: 前端应用在用户认证成功后，调用此Function来获取全部保险数据。

### 4.2. KPI 看板 (F-KPI)
*   (同V3.5.0，其下方会包含AI智能总体业务摘要区域，通过应用头部的AI按钮触发，调用受保护的AI代理Function)

### 4.3. 趋势分析 (F-TREND)
*   (同V3.5.0)
*   F-TREND-003: X轴标签优化: X轴的周期标签将显示当周的最后一天（周六）的日期，格式为 "YY-MM-DD"（例如 "25-06-14"），以增强时间维度的可读性和简洁性。在“累计”分析模式下，X轴标签将始终水平显示。 Tooltip中的周期显示会包含完整的周起止日期范围。
*   F-TREND-004: 布局优化: 通过调整图表边距，确保图表内容（包括坐标轴、图例、标签）在标准视图下不会溢出其容器。
*   并在其下方包含独立的AI图表分析功能模块和触发按钮，调用受保护的AI代理Function。

### 4.4. 对比气泡图 (F-BUBBLE)
*   (同V3.5.0，并在其下方包含独立的AI图表分析功能模块和触发按钮，调用受保护的AI代理Function)

### 4.5. 水平条形图排名 (F-RANK)
*   (同V3.5.0，并在其下方包含独立的AI图表分析功能模块和触发按钮，调用受保护的AI代理Function)

### 4.6. 占比图 (F-SHARE)
*   (同V3.5.0，并在其下方包含独立的AI图表分析功能模块和触发按钮，调用受保护的AI代理Function)

### 4.7. 帕累托图 (F-PARETO)
*   (同V3.5.0，并在其下方包含独立的AI图表分析功能模块和触发按钮，调用受保护的AI代理Function)

### 4.8. 数据表显示 (F-TABLE)
*   (同V3.5.0)

### 4.9. 全局筛选与控制
*   F-CTRL-001: 分析模式切换
*   F-CTRL-002: 当前数据周期选择
*   F-CTRL-002B: 对比数据周期选择
*   F-CTRL-003: 业务类型筛选 (同V3.5.0最终实现)
*   F-CTRL-004: 数据导出
*   F-CTRL-005: 视图切换

### 4.10. AI 智能分析 (通过受保护的Firebase Function)
*   F-AI-001: **总体业务摘要**。通过调用后端的AI代理Firebase Function (`generateAiSummaryProxy`)实现。此摘要模块固定显示在KPI看板的下方，当KPI视图激活时，通过应用头部的AI摘要按钮触发。
*   F-AI-002: **图表AI分析**。各图表（趋势、气泡、排名、占比、帕累托）均在其下方提供独立的AI分析功能模块和触发按钮。每个模块将基于当前图表显示的数据，调用AI代理Function生成分析。
*   F-AI-003: **API密钥安全**: AI API密钥配置在Firebase Function的环境变量中，不由前端直接管理。
*   F-AI-004: **认证保护**: `generateAiSummaryProxy` Function 必须验证调用者的 Firebase ID Token，只有已认证的用户才能使用AI功能。

## 5. 非功能性需求
*   (同V3.5.0，但移除“原型登录安全提示”)
*   NF-SEC-001: AI API密钥安全: AI API密钥存储在Firebase Function环境变量中，不暴露于客户端。
*   NF-SEC-002: **数据访问安全**: 原始数据通过受Firebase Authentication保护的Firebase Function提供，防止未授权访问。
*   NF-SEC-003: **功能访问安全**: AI分析功能通过受Firebase Authentication保护的Firebase Function提供。
*   NF-PERF-001: AI和数据请求为异步，UI应有加载状态提示，避免阻塞。
*   NF-UI-001: 图表布局: 所有图表应在其指定容器内正确显示，避免内容溢出。趋势图X轴标签在累计模式下水平显示，格式为YY-MM-DD。

## 6. 设计与用户体验
*   (同V3.5.0，但登录流程描述更新为Firebase Auth)
*   **6.1 登录流程**:
    *   用户首次访问应用时，若未登录，则自动跳转到登录页面。
    *   登录页面使用Firebase Authentication，例如邮箱/密码登录。
    *   登录成功后跳转到主仪表盘页面。
    *   登录失败时，在登录页面显示Firebase提供的错误提示。
*   6.4 AI交互:
    *   应用头部的AI摘要按钮用于触发KPI看板下方的总体业务摘要。
    *   每个图表（趋势、气泡、排名、占比、帕累托）下方均有独立的AI分析模块，包含一个按钮，点击后生成并显示针对该图表的分析。
    *   UI显示加载状态，结果以Markdown格式渲染。
*   6.5 图表可读性: 趋势图的X轴标签将清晰显示当周最后一天（周六）的日期，格式为 "YY-MM-DD"，并在累计模式下水平展示。
*   **6.6 用户状态**: 应用头部清晰显示用户登录状态（例如通过当前用户邮箱和“登出”按钮）。

### 6.3. 全局数值显示格式化规则
*   (同V3.5.0)

## 7. 数据需求
*   主要数据源: **通过受保护的 Firebase Function (`getInsuranceData`) 提供**。原始JSON文件 (`insurance_data.json`) 将存放于 `functions/src/data/` 目录。
*   AI分析输入数据: 由前端根据当前KPI或图表的筛选和状态准备，传递给受保护的Firebase Function (`generateAiSummaryProxy`)。
*   **Firebase前端配置**: 需要在前端配置Firebase SDK (API Key, Auth Domain等)，建议通过环境变量管理。

## 8. 未来展望 (可选)
*   (其他无变化)

## 9. 附录
*   `FIELD_DICTIONARY_V4.md`
*   `FIELD_LINEAGE.md` (若存在)
*   `ISSUES_LOG.md`

---
修订历史

| 版本  | 日期       | 修订人     | 修订说明                                                                                                |
| :---- | :--------- | :------- | :------------------------------------------------------------------------------------------------------ |
| ...   | ...        | ...      | ... (保留之前所有记录)                                                                                    |
| 3.5.0 | (先前日期) | AI项目大师 | 新增原型级用户名/密码登录功能。仪表盘内容受登录保护。                                                         |
| 3.6.0 | (当前日期) | AI项目大师 | 集成Firebase Authentication替换原型登录。创建受保护的Firebase Function (`getInsuranceData`) 提供数据。保护现有AI代理Function (`generateAiSummaryProxy`)。更新前端以使用Firebase Auth并调用受保护的Functions。 |

