# 产品需求与系统设计文档 (PRD) - 车险经营分析周报

**版本**: 9.0.0 (As-Built: 纯粹的数据可视化架构)
**最后更新日期**: (当前日期)
**负责人**: AI项目大师

## 1. 引言

### 1.1. 文档目的
本文档作为“车险经营分析周报”应用的**核心设计与实现蓝图 (As-Built Documentation)**。它旨在为开发人员、架构师、测试人员和系统维护者提供一个关于应用功能、技术架构、实现细节和部署方法的全面、精确、单一信息源。

本文档的目标是确保任何具备相应技术栈能力的开发者，都能够**基于此文档从零开始，完整地理解、构建并复刻出与当前线上版本功能完全一致的应用**。

### 1.2. 应用范围与核心价值
本应用是一个**安全、交互式、高性能**的车险经营分析仪表盘。其核心价值在于：
*   **安全性**: 通过 **Firebase Authentication** 进行用户认证，并通过 **Firestore 安全规则** 保障后端数据的访问安全。
*   **数据驱动**: 为车险业务分析师和管理层提供一个直观、高效的数据可视化分析平台。
*   **深度分析**: **将全部16个核心KPI指标全面集成**到所有图表视图和数据表中，提供前所未有的分析深度和灵活性。
*   **标准化**: 确保所有核心业务指标的计算口径和展现逻辑全公司统一。

### 1.3. 目标受众
*   **开发人员**: 用于理解功能需求、技术实现和进行二次开发。
*   **系统维护者**: 用于了解系统架构、部署和排查问题。
*   **产品与业务分析师**: 用于明确已实现的功能和业务逻辑。

### 1.4. 关键术语与定义
| 术语 | 英文/ID | 定义 |
| :--- | :--- | :--- |
| **YTD** | Year To Date | 本年迄今累计值。 |
| **PoP** | Period over Period | 环比分析模式，分析“当周发生额”。 |
| **当周发生额** | Period Value | `当前周期YTD值 - 上一周期YTD值`。在PoP模式下，所有指标均基于此重新计算。 |
| **数据源** | Data Source | **Firestore 数据库**。前端在用户认证后，使用客户端SDK直接查询。 |
| **认证服务** | Authentication | **Firebase Authentication**，使用邮箱/密码登录。 |
| **安全模型** | Security Model | **客户端直连 + Firestore安全规则**。 |
| **字段字典** | `FIELD_DICTIONARY.md` | **(重要)** 定义了所有业务指标的精确计算逻辑、数据来源和处理规则。 |

---

## 2. 系统架构

### 2.1. 技术栈
*   **前端**:
    *   **框架**: Next.js (App Router, **纯客户端渲染模式**)
    *   **语言**: TypeScript
    *   **UI组件**: ShadCN UI
    *   **样式**: Tailwind CSS
    *   **图表**: Recharts
    *   **状态管理**: React Hooks (`useState`, `useEffect`, `useMemo`, `useCallback`)
    *   **Firebase SDK**: `firebase/app`, `firebase/auth`, `firebase/firestore`
*   **后端/BaaS (Backend as a Service)**:
    *   **数据库**: Google Firestore
    *   **认证**: Firebase Authentication

### 2.2. 数据流架构 (最终版)
本应用采用安全、高效、纯粹的无服务器 (Serverless) 架构，数据流如下：
1.  **用户访问与认证**: 用户通过 `/login` 页面使用 Firebase Authentication 进行认证。
2.  **主数据获取 (实时)**:
    *   认证成功后，主仪表盘页面 (`/`) 使用 Firestore 客户端SDK的 `onSnapshot` 方法，建立与 `v4_period_data` 集合的**实时监听连接**。
    *   任何在 Firestore 中的数据变更都会被实时推送到客户端，并自动触发UI的重新渲染。
    *   数据访问由 Firestore 安全规则保护，仅允许已认证用户读取。
3.  **数据处理与可视化**:
    *   所有的数据处理、聚合和KPI计算逻辑均在客户端的`src/lib/data-utils.ts`中执行。
    *   前端组件（如图表、数据表）接收处理后的数据，并通过Recharts等库进行可视化展示。
    *   **此架构不涉及任何后端计算或API路由，确保了部署的简单性和可靠性。**

---

## 3. 核心功能需求 (F-REQ)

### 3.1. 数据架构与获取 (F-DATA)
*   **F-DATA-01**: 应用必须通过Firebase客户端SDK安全地、实时地从Firestore的`v4_period_data`集合获取数据。
*   **F-DATA-02**: 应用必须依赖Firestore安全规则（`allow read: if request.auth != null;`）来保障数据安全。

### 3.2. 全局筛选与控制 (F-CTRL)
*   **F-CTRL-01**: 提供“累计/当周发生额”分析模式切换。
*   **F-CTRL-02**: 提供当前数据周期和对比周期的选择器。
*   **F-CTRL-03**: 提供强大的业务类型多选筛选器，支持全选、反选、清空和单选操作。
*   **F-CTRL-04**: 提供将当前数据表视图导出为CSV文件的功能。

### 3.3. KPI看板 (F-KPI)
*   **F-KPI-01**: 以16个核心KPI卡片的形式，清晰展示当前筛选条件下的业务表现。
*   **F-KPI-02**: 每个KPI卡片必须显示其与对比周期的变化情况（百分比和/或绝对值）。
*   **F-KPI-03**: KPI卡片必须根据风险规则（如高`variable_cost_ratio`）动态显示颜色警告。

### 3.4. 图表与数据视图 (F-VIEWS)
*   **F-VIEWS-01**: 应用提供包括KPI看板、趋势图、气泡图、排名图、占比图、帕累托图和数据表在内的多个分析视图。
*   **F-VIEWS-02**: **指标全面性**:
    *   趋势图、气泡图、排名图的指标选择器中，必须提供**全部16个核心KPI指标**作为可选项。
    *   占比图、帕累托图的指标选择器中，必须提供所有适合进行此类分析的**核心KPI指标**（如保费、赔款、费用、边贡额、保单件数等）。
*   **F-VIEWS-03**: **数据表完整性**: 数据表视图必须以表格形式，完整、清晰地展示全部16个核心KPI指标的当前值，并在“环比”模式下展示其对比变化。

---

## 4. 项目从0到1复刻指南

### 4.1. 环境准备
*   安装 [Node.js](https://nodejs.org/) (v20 或更高版本)
*   一个 [Firebase](https://firebase.google.com/) 项目

### 4.2. Firebase项目设置
1.  在Firebase控制台创建一个新项目。
2.  启用 **Authentication** 并选择“邮箱/密码”登录方式。至少创建一个测试用户。
3.  启用 **Firestore Database**。
4.  在Firestore中创建名为 `v4_period_data` 的集合，并上传您的数据文档。
5.  **关键**: 在Firestore的**Rules**标签页中，发布以下安全规则，确保只有登录用户可以读取数据：
    ```
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /{document=**} {
          allow read, write: if request.auth != null;
        }
      }
    }
    ```
6.  在项目设置中，记录您的Firebase项目配置信息（API Key, Auth Domain等）。

### 4.3. 本地应用配置与运行
1.  克隆仓库。
2.  在项目根目录创建 `.env.local` 文件，并填入您的Firebase项目配置信息。参考 `.env.local.example`。
3.  安装依赖: `npm install`
4.  启动开发服务器: `npm run dev`

### 4.4. 部署应用 (自动化CI/CD)
1.  **获取服务账户密钥**: 在Firebase控制台为您的项目生成一个新的服务账户私钥JSON文件。
2.  **配置GitHub仓库Secrets**:
    *   在您的GitHub仓库中，导航到 `Settings` > `Secrets and variables` > `Actions`。
    *   创建名为 `FIREBASE_SERVICE_ACCOUNT` 的新密钥，并将下载的JSON文件的**全部内容**粘贴到值中。
3.  **触发部署**: 将您的代码提交并推送到 `main` 分支。GitHub Actions将自动构建并部署应用到Firebase Hosting。

---

## 5. 修订历史

| 版本  | 日期       | 修订人     | 修订说明                                                                                                                                                             |
| :---- | :--------- | :------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ...   | ...        | ...      | ... (保留之前所有记录)                                                                                                                                               |
| 8.0.0 | (先前日期) | AI项目大师 | **架构重大演进**: 为解决部署问题，先后尝试移除Genkit、引入Cloudflare代理等方案。但最终发现Next.js API路由与Firebase Spark套餐存在根本性部署冲突。 |
| 9.0.0 | (当前日期) | AI项目大师 | **最终架构定型**: 为确保项目的绝对稳定和可靠交付，**彻底移除了所有AI相关功能**，将应用简化为纯粹的前端数据可视化工具。同时，**将全部16个核心KPI指标全面集成**到所有分析视图中，极大增强了应用的核心价值。 |

